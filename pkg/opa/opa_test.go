package opa

import (
	"fmt"
	"testing"
)

func TestGetOpaPolicy(t *testing.T) {
	testCases := []struct {
		policyLocation string
		query          string
		name           string
		plan           string
		err            error
	}{
		{"./../../policies/opa-azure-policy.rego", "data.terraform.analysis.authz", "aks-create", "{\"format_version\":\"0.2\",\"terraform_version\":\"1.0.7\",\"planned_values\":{\"root_module\":{\"resources\":[{\"address\":\"azurerm_kubernetes_cluster.example\",\"mode\":\"managed\",\"type\":\"azurerm_kubernetes_cluster\",\"name\":\"example\",\"provider_name\":\"registry.terraform.io/hashicorp/azurerm\",\"schema_version\":0,\"values\":{\"api_server_authorized_ip_ranges\":null,\"automatic_channel_upgrade\":null,\"default_node_pool\":[{\"availability_zones\":null,\"enable_auto_scaling\":null,\"enable_host_encryption\":null,\"enable_node_public_ip\":null,\"fips_enabled\":null,\"kubelet_config\":[],\"linux_os_config\":[],\"max_count\":null,\"min_count\":null,\"name\":\"default\",\"node_count\":1,\"node_public_ip_prefix_id\":null,\"node_taints\":null,\"only_critical_addons_enabled\":null,\"os_disk_type\":\"Managed\",\"pod_subnet_id\":null,\"proximity_placement_group_id\":null,\"tags\":null,\"type\":\"VirtualMachineScaleSets\",\"ultra_ssd_enabled\":false,\"upgrade_settings\":[],\"vm_size\":\"Standard_D2_v2\",\"vnet_subnet_id\":null}],\"disk_encryption_set_id\":null,\"dns_prefix\":\"exampleaks1\",\"dns_prefix_private_cluster\":null,\"enable_pod_security_policy\":null,\"identity\":[{\"type\":\"SystemAssigned\",\"user_assigned_identity_id\":null}],\"linux_profile\":[],\"local_account_disabled\":null,\"location\":\"westeurope\",\"maintenance_window\":[],\"name\":\"example-aks1\",\"private_cluster_public_fqdn_enabled\":false,\"resource_group_name\":\"example-resources\",\"service_principal\":[],\"sku_tier\":\"Free\",\"tags\":{\"Environment\":\"Production\"},\"timeouts\":null},\"sensitive_values\":{\"addon_profile\":[],\"auto_scaler_profile\":[],\"default_node_pool\":[{\"kubelet_config\":[],\"linux_os_config\":[],\"node_labels\":{},\"upgrade_settings\":[]}],\"identity\":[{}],\"kube_admin_config\":[],\"kube_config\":[],\"kubelet_identity\":[],\"linux_profile\":[],\"maintenance_window\":[],\"network_profile\":[],\"role_based_access_control\":[],\"service_principal\":[],\"tags\":{},\"windows_profile\":[]}},{\"address\":\"azurerm_resource_group.example\",\"mode\":\"managed\",\"type\":\"azurerm_resource_group\",\"name\":\"example\",\"provider_name\":\"registry.terraform.io/hashicorp/azurerm\",\"schema_version\":0,\"values\":{\"location\":\"westeurope\",\"name\":\"example-resources\",\"tags\":null,\"timeouts\":null},\"sensitive_values\":{}}]}},\"resource_changes\":[{\"address\":\"azurerm_kubernetes_cluster.example\",\"mode\":\"managed\",\"type\":\"azurerm_kubernetes_cluster\",\"name\":\"example\",\"provider_name\":\"registry.terraform.io/hashicorp/azurerm\",\"change\":{\"actions\":[\"create\"],\"before\":null,\"after\":{\"api_server_authorized_ip_ranges\":null,\"automatic_channel_upgrade\":null,\"default_node_pool\":[{\"availability_zones\":null,\"enable_auto_scaling\":null,\"enable_host_encryption\":null,\"enable_node_public_ip\":null,\"fips_enabled\":null,\"kubelet_config\":[],\"linux_os_config\":[],\"max_count\":null,\"min_count\":null,\"name\":\"default\",\"node_count\":1,\"node_public_ip_prefix_id\":null,\"node_taints\":null,\"only_critical_addons_enabled\":null,\"os_disk_type\":\"Managed\",\"pod_subnet_id\":null,\"proximity_placement_group_id\":null,\"tags\":null,\"type\":\"VirtualMachineScaleSets\",\"ultra_ssd_enabled\":false,\"upgrade_settings\":[],\"vm_size\":\"Standard_D2_v2\",\"vnet_subnet_id\":null}],\"disk_encryption_set_id\":null,\"dns_prefix\":\"exampleaks1\",\"dns_prefix_private_cluster\":null,\"enable_pod_security_policy\":null,\"identity\":[{\"type\":\"SystemAssigned\",\"user_assigned_identity_id\":null}],\"linux_profile\":[],\"local_account_disabled\":null,\"location\":\"westeurope\",\"maintenance_window\":[],\"name\":\"example-aks1\",\"private_cluster_public_fqdn_enabled\":false,\"resource_group_name\":\"example-resources\",\"service_principal\":[],\"sku_tier\":\"Free\",\"tags\":{\"Environment\":\"Production\"},\"timeouts\":null},\"after_unknown\":{\"addon_profile\":true,\"auto_scaler_profile\":true,\"default_node_pool\":[{\"kubelet_config\":[],\"kubelet_disk_type\":true,\"linux_os_config\":[],\"max_pods\":true,\"node_labels\":true,\"orchestrator_version\":true,\"os_disk_size_gb\":true,\"os_sku\":true,\"upgrade_settings\":[]}],\"fqdn\":true,\"id\":true,\"identity\":[{\"principal_id\":true,\"tenant_id\":true}],\"kube_admin_config\":true,\"kube_admin_config_raw\":true,\"kube_config\":true,\"kube_config_raw\":true,\"kubelet_identity\":true,\"kubernetes_version\":true,\"linux_profile\":[],\"maintenance_window\":[],\"network_profile\":true,\"node_resource_group\":true,\"private_cluster_enabled\":true,\"private_dns_zone_id\":true,\"private_fqdn\":true,\"private_link_enabled\":true,\"role_based_access_control\":true,\"service_principal\":[],\"tags\":{},\"windows_profile\":true},\"before_sensitive\":false,\"after_sensitive\":{\"addon_profile\":[],\"auto_scaler_profile\":[],\"default_node_pool\":[{\"kubelet_config\":[],\"linux_os_config\":[],\"node_labels\":{},\"upgrade_settings\":[]}],\"identity\":[{}],\"kube_admin_config\":[],\"kube_admin_config_raw\":true,\"kube_config\":[],\"kube_config_raw\":true,\"kubelet_identity\":[],\"linux_profile\":[],\"maintenance_window\":[],\"network_profile\":[],\"role_based_access_control\":[],\"service_principal\":[],\"tags\":{},\"windows_profile\":[]}}},{\"address\":\"azurerm_resource_group.example\",\"mode\":\"managed\",\"type\":\"azurerm_resource_group\",\"name\":\"example\",\"provider_name\":\"registry.terraform.io/hashicorp/azurerm\",\"change\":{\"actions\":[\"create\"],\"before\":null,\"after\":{\"location\":\"westeurope\",\"name\":\"example-resources\",\"tags\":null,\"timeouts\":null},\"after_unknown\":{\"id\":true},\"before_sensitive\":false,\"after_sensitive\":{}}}],\"configuration\":{\"provider_config\":{\"azurerm\":{\"name\":\"azurerm\",\"expressions\":{\"disable_terraform_partner_id\":{\"constant_value\":true},\"features\":[{\"key_vault\":[{\"purge_soft_delete_on_destroy\":{\"constant_value\":true}}]}],\"skip_provider_registration\":{\"constant_value\":true}}}},\"root_module\":{\"resources\":[{\"address\":\"azurerm_kubernetes_cluster.example\",\"mode\":\"managed\",\"type\":\"azurerm_kubernetes_cluster\",\"name\":\"example\",\"provider_config_key\":\"azurerm\",\"expressions\":{\"default_node_pool\":[{\"name\":{\"constant_value\":\"default\"},\"node_count\":{\"constant_value\":1},\"vm_size\":{\"constant_value\":\"Standard_D2_v2\"}}],\"dns_prefix\":{\"constant_value\":\"exampleaks1\"},\"identity\":[{\"type\":{\"constant_value\":\"SystemAssigned\"}}],\"location\":{\"references\":[\"azurerm_resource_group.example.location\",\"azurerm_resource_group.example\"]},\"name\":{\"constant_value\":\"example-aks1\"},\"resource_group_name\":{\"references\":[\"azurerm_resource_group.example.name\",\"azurerm_resource_group.example\"]},\"tags\":{\"constant_value\":{\"Environment\":\"Production\"}}},\"schema_version\":0},{\"address\":\"azurerm_resource_group.example\",\"mode\":\"managed\",\"type\":\"azurerm_resource_group\",\"name\":\"example\",\"provider_config_key\":\"azurerm\",\"expressions\":{\"location\":{\"constant_value\":\"West Europe\"},\"name\":{\"constant_value\":\"example-resources\"}},\"schema_version\":0}]}}}", nil},
		{"./../../policies/opa-azure-policy.rego", "data.terraform.analysis.deny[x]", "delete-rg", "{\"format_version\":\"0.2\",\"terraform_version\":\"1.0.7\",\"planned_values\":{\"root_module\":{}},\"resource_drift\":[{\"address\":\"azurerm_resource_group.brad_test\",\"mode\":\"managed\",\"type\":\"azurerm_resource_group\",\"name\":\"brad_test\",\"provider_name\":\"registry.terraform.io/hashicorp/azurerm\",\"change\":{\"actions\":[\"update\"],\"before\":{\"id\":\"/subscriptions/57b482cf-3355-4f0c-8adb-6d6bbb1b2cf7/resourceGroups/brad-test\",\"location\":\"southcentralus\",\"name\":\"brad-test\",\"tags\":null,\"timeouts\":null},\"after\":{\"id\":\"/subscriptions/57b482cf/resourceGroups/brad-test\",\"location\":\"southcentralus\",\"name\":\"brad-test\",\"tags\":{},\"timeouts\":null},\"before_sensitive\":{},\"after_sensitive\":{\"tags\":{}}}}],\"resource_changes\":[{\"address\":\"azurerm_resource_group.brad_test\",\"mode\":\"managed\",\"type\":\"azurerm_resource_group\",\"name\":\"brad_test\",\"provider_name\":\"registry.terraform.io/hashicorp/azurerm\",\"change\":{\"actions\":[\"delete\"],\"before\":{\"id\":\"/subscriptions/57b482cf/resourceGroups/brad-test\",\"location\":\"southcentralus\",\"name\":\"brad-test\",\"tags\":{},\"timeouts\":null},\"after\":null,\"after_unknown\":{},\"before_sensitive\":{\"tags\":{}},\"after_sensitive\":false}}],\"prior_state\":{\"format_version\":\"0.2\",\"terraform_version\":\"1.0.7\",\"values\":{\"root_module\":{\"resources\":[{\"address\":\"azurerm_resource_group.brad_test\",\"mode\":\"managed\",\"type\":\"azurerm_resource_group\",\"name\":\"brad_test\",\"provider_name\":\"registry.terraform.io/hashicorp/azurerm\",\"schema_version\":0,\"values\":{\"id\":\"/subscriptions/57b482cf/resourceGroups/brad-test\",\"location\":\"southcentralus\",\"name\":\"brad-test\",\"tags\":{},\"timeouts\":null},\"sensitive_values\":{\"tags\":{}}}]}}},\"configuration\":{\"provider_config\":{\"azurerm\":{\"name\":\"azurerm\",\"expressions\":{\"disable_terraform_partner_id\":{\"constant_value\":true},\"features\":[{\"key_vault\":[{\"purge_soft_delete_on_destroy\":{\"constant_value\":true}}]}],\"skip_provider_registration\":{\"constant_value\":true}}}},\"root_module\":{}}}", nil},
	}

	for _, tc := range testCases {
		score := GetOpaScore([]byte(tc.plan), tc.policyLocation, "data.terraform.analysis.score")
		fmt.Println(tc.name, score)
		result := CheckIfPlanPassesOpaPolicy([]byte(tc.plan), tc.policyLocation, tc.query)
		fmt.Println(tc.name, result)
		response := RetrieveOpaPolicyResponse([]byte(tc.plan), tc.policyLocation, tc.query)
		fmt.Println(response)
	}
}
